<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Students & Grades</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #subjectModal.show {
      display: flex;
      animation: fadeIn 0.2s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-white font-sans">

    <nav class="bg-slate-900/80 backdrop-blur-sm px-4 sm:px-6 py-4 flex flex-wrap justify-between items-center shadow-lg border-b border-slate-700">
    <h1 class="text-base sm:text-lg font-bold tracking-wide text-indigo-400 text-center sm:text-left w-full sm:w-auto mb-2 sm:mb-0">
      Barretto SHS Information Management System (BSHSIMS)
    </h1>
    <button onclick="goBack()" class="bg-slate-700 hover:bg-slate-600 px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg text-sm font-medium transition-all duration-200 w-full sm:w-auto text-center">
      ← Back
    </button>
  </nav>

  <main class="max-w-7xl mx-auto p-4 sm:p-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
      <h2 id="classTitle" class="text-2xl sm:text-3xl font-bold text-indigo-300 text-center sm:text-left"></h2>
    </div>

       <div class="flex flex-wrap justify-center sm:justify-start gap-3 mb-6">
      <button onclick="addStudent()" class="bg-indigo-600 hover:bg-indigo-500 px-4 sm:px-5 py-2 rounded-lg font-semibold shadow-md transition w-full sm:w-auto">
        + Add Student
      </button>
      <button onclick="manageSubjects()" class="bg-emerald-600 hover:bg-emerald-500 px-4 sm:px-5 py-2 rounded-lg font-semibold shadow-md transition w-full sm:w-auto">
        ⚙️ Manage Subjects
      </button>
    </div>

       <div class="overflow-x-auto shadow-lg rounded-2xl border border-slate-700">
      <table class="min-w-full text-sm sm:text-base bg-slate-800 rounded-2xl overflow-hidden">
        <thead class="bg-slate-900 text-slate-300 uppercase tracking-wide text-xs sm:text-sm">
          <tr id="tableHead"></tr>
        </thead>
        <tbody id="studentList" class="divide-y divide-slate-700 text-sm sm:text-base"></tbody>
      </table>
    </div>
  </main>

  <div id="subjectModal" class="hidden fixed inset-0 bg-black/70 items-center justify-center z-50 p-4 sm:p-0">
    <div class="bg-slate-900 p-5 sm:p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-700 mx-auto">
      <h3 class="text-xl sm:text-2xl font-bold mb-3 text-indigo-300 text-center sm:text-left">Manage Subjects</h3>

      <ul id="subjectList" class="mb-4 space-y-2 max-h-64 overflow-y-auto pr-2 text-sm sm:text-base"></ul>

      <div class="flex flex-col sm:flex-row gap-2 mb-4">
        <input id="newSubject" type="text" placeholder="New subject name"
               class="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
        <button onclick="addNewSubject()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded font-semibold transition w-full sm:w-auto">
          Add
        </button>
      </div>

      <div class="text-center sm:text-right">
        <button onclick="closeSubjectModal()" class="bg-red-600 hover:bg-red-500 px-5 py-2 rounded-lg font-semibold transition w-full sm:w-auto">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    if (localStorage.getItem("adminLogged") !== "true") {
      window.location.href = "admin-login.html";
    }

    const classKey = "bshsims_classes_admin";
    const classIndex = localStorage.getItem("selectedClass");
    let classes = JSON.parse(localStorage.getItem(classKey) || "[]");
    let currentClass = classes[classIndex];

    if (!currentClass.subjects) {
      currentClass.subjects = [
        "Piling Larang", "UCSP", "Contact Center Services", "EAPP",
        "PR2", "Personal Development", "PE"
      ];
    }

    const subjects = currentClass.subjects;
    document.getElementById("classTitle").innerText = `${currentClass.name} - ${currentClass.section}`;

    function renderHeader() {
      const headRow = document.getElementById("tableHead");
      headRow.innerHTML = `
        <th class="p-3 text-left whitespace-nowrap">Student ID</th>
        <th class="p-3 text-left whitespace-nowrap">Name</th>
        <th class="p-3 text-center whitespace-nowrap">Password</th>
        ${subjects.map(sub => `<th class="p-3 text-center whitespace-nowrap">${sub}</th>`).join("")}
        <th class="p-3 text-center whitespace-nowrap">Average</th>
        <th class="p-3 text-center whitespace-nowrap">Status</th>
        <th class="p-3 text-center whitespace-nowrap">Action</th>
      `;
    }

    function renderStudents() {
      renderHeader();
      const tbody = document.getElementById("studentList");
      tbody.innerHTML = "";

      if (!currentClass.students || currentClass.students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${subjects.length + 5}" class="text-center text-slate-400 p-6">No students yet in this class.</td></tr>`;
        return;
      }

      currentClass.students.forEach((s, i) => {
        const avg = computeAverage(s);
        const status = avg === "-" ? "-" : (avg >= 75 ? "✅ Passed" : "❌ Failed");

        const row = document.createElement("tr");
        row.className = "hover:bg-slate-700/50 transition";
        row.innerHTML = `
          <td class="p-3 text-center font-mono text-xs sm:text-sm">${s.id}</td>
          <td class="p-3 font-medium text-xs sm:text-sm">${s.name}</td>
          <td class="p-2 text-center">
            <input type="text" value="${s.password}" onchange="updatePassword(${i}, this.value)"
                   class="w-24 sm:w-32 text-center rounded bg-slate-700 border border-slate-600 focus:ring-2 focus:ring-indigo-500 text-xs sm:text-sm"/>
          </td>
          ${subjects.map(sub => `
            <td class="p-2 text-center">
              <input type="number" value="${s.grades[sub] ?? ''}" onchange="updateGrade(${i}, '${sub}', this.value)"
                     class="w-16 sm:w-20 text-center rounded bg-slate-700 border border-slate-600 focus:ring-2 focus:ring-indigo-500 text-xs sm:text-sm"/>
            </td>
          `).join("")}
          <td class="p-3 text-center text-yellow-400 font-semibold text-xs sm:text-sm">${avg}</td>
          <td class="p-3 text-center text-xs sm:text-sm">${status}</td>
          <td class="p-3 text-center">
            <button onclick="deleteStudent(${i})" class="bg-red-600 hover:bg-red-500 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm font-medium">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function addStudent() {
      const id = prompt("Enter Student ID (e.g. STU1001):");
      if (!id) return;
      const name = prompt("Enter student name:");
      if (!name) return;
      const password = prompt("Enter password:") || "password123";

      const newStudent = { id, name, password, grades: {} };
      subjects.forEach(sub => newStudent.grades[sub] = null);

      if (!currentClass.students) currentClass.students = [];
      currentClass.students.push(newStudent);
      saveAll();
      renderStudents();
    }

    function manageSubjects() {
      const modal = document.getElementById("subjectModal");
      const list = document.getElementById("subjectList");
      list.innerHTML = subjects.map((sub, index) => `
        <li class="flex justify-between bg-slate-800 px-3 py-2 rounded-lg shadow-sm text-sm sm:text-base">
          <span>${sub}</span>
          <button onclick="removeSubject(${index})" class="text-red-400 hover:text-red-500 font-bold">✖</button>
        </li>
      `).join("");
      modal.classList.add("show");
      modal.classList.remove("hidden");
    }

    function addNewSubject() {
      const input = document.getElementById("newSubject");
      const name = input.value.trim();
      if (!name) return alert("Enter subject name!");
      if (subjects.includes(name)) return alert("Subject already exists!");
      subjects.push(name);
      currentClass.subjects = subjects;
      saveAll();
      input.value = "";
      manageSubjects();
      renderStudents();
    }

    function removeSubject(index) {
      if (!confirm("Remove this subject?")) return;
      const removed = subjects.splice(index, 1);
      currentClass.students?.forEach(s => delete s.grades[removed[0]]);
      currentClass.subjects = subjects;
      saveAll();
      manageSubjects();
      renderStudents();
    }

    function closeSubjectModal() {
      document.getElementById("subjectModal").classList.add("hidden");
    }

    function updatePassword(index, newPass) {
      currentClass.students[index].password = newPass;
      saveAll();
    }

    function updateGrade(index, subject, value) {
      const num = Number(value);
      if (isNaN(num)) return;
      currentClass.students[index].grades[subject] = num;
      saveAll();
      renderStudents();
    }

    function deleteStudent(i) {
      if (!confirm("Remove this student?")) return;
      currentClass.students.splice(i, 1);
      saveAll();
      renderStudents();
    }

    function computeAverage(student) {
      const grades = Object.values(student.grades || {}).filter(g => g != null);
      if (grades.length === 0) return "-";
      const total = grades.reduce((a, b) => a + Number(b), 0);
      return (total / grades.length).toFixed(2);
    }

    function saveAll() {
      classes[classIndex] = currentClass;
      localStorage.setItem(classKey, JSON.stringify(classes));
    }

    function goBack() {
      window.location.href = "adminclass.html";
    }

    renderStudents();
  </script>
</body>
</html>